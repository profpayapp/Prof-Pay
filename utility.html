<script type="module">
import { logTransaction } from './firebase-logging.js';

/* ---------- Offline Storage ---------- */
function saveOfflineTransaction(transaction) {
  const request = indexedDB.open('profpay-db', 1);
  request.onupgradeneeded = e => {
    const db = e.target.result;
    if (!db.objectStoreNames.contains('transactions')) {
      db.createObjectStore('transactions', { autoIncrement: true });
    }
  };
  request.onsuccess = e => {
    const db = e.target.result;
    const tx = db.transaction('transactions', 'readwrite');
    tx.objectStore('transactions').add(transaction);
  };
}

function getOfflineTransactions(callback) {
  const request = indexedDB.open('profpay-db', 1);
  request.onsuccess = e => {
    const db = e.target.result;
    const tx = db.transaction('transactions', 'readonly');
    const store = tx.objectStore('transactions');
    const getAll = store.getAll();
    getAll.onsuccess = () => callback(getAll.result || []);
  };
}

/* ---------- UI Helper ---------- */
function handleButton(button, action) {
  button.disabled = true;
  const originalText = button.innerText;
  button.innerText = "Processing...";

  setTimeout(() => {
    action();
    button.disabled = false;
    button.innerText = originalText;
  }, 800);
}

/* ---------- Transaction Processor ---------- */
function processTransaction(service, amount) {
  const transaction = {
    user_email: 'admin@profpay.com',
    service,
    amount,
    payment_method: 'TACC',
    status: 'success',
    date: new Date().toISOString()
  };

  if (navigator.onLine) {
    logTransaction(
      transaction.user_email,
      transaction.service,
      transaction.amount,
      transaction.payment_method,
      transaction.status
    );
    alert(`✅ ${service} of ${amount} logged successfully`);
  } else {
    saveOfflineTransaction(transaction);
    alert(`⚠️ Offline: ${service} saved and will sync automatically`);
  }
}

/* ---------- Button Events ---------- */
document.getElementById("buy-airtime").onclick = e => {
  const amount = Number(document.getElementById("airtime-amount").value) || 1;
  handleButton(e.target, () => processTransaction("Airtime", amount));
};

document.getElementById("buy-data").onclick = e => {
  const amount = Number(document.getElementById("data-amount").value) || 1;
  handleButton(e.target, () => processTransaction("Data", amount));
};

document.getElementById("buy-electricity").onclick = e => {
  const amount = Number(document.getElementById("electricity-amount").value) || 1;
  handleButton(e.target, () => processTransaction("Electricity", amount));
};

document.getElementById("buy-tv").onclick = e => {
  const amount = Number(document.getElementById("tv-amount").value) || 1;
  handleButton(e.target, () => processTransaction("TV Subscription", amount));
};

/* ---------- Auto Sync When Back Online ---------- */
window.addEventListener('online', () => {
  getOfflineTransactions(transactions => {
    transactions.forEach(tx => {
      logTransaction(tx.user_email, tx.service, tx.amount, tx.payment_method, tx.status);
    });

    const request = indexedDB.open('profpay-db', 1);
    request.onsuccess = e => {
      const db = e.target.result;
      const tx = db.transaction('transactions', 'readwrite');
      tx.objectStore('transactions').clear();
    };
  });
});
</script>
